#!/bin/bash

[ -z "$OAR_NODEFILE" ] && echo "not in an OAR job" && exit 1

MODELS="
collision.5;10
peterson.5.large.10;20
firewire_tree.6;10
firewire_tree.7;10
firewire_tree.8;10
leader_election.6;12
leader_election.7;12"

SINGLE_BUFFER_SIZES="
16000
64000
256000
1024000"

NODES="64 56 48 40 32 24 16 12 8 4"

PROCS_PER_NODE="4 2 1"
PROCS_PER_NODE="4"

REPETITION=2

HASH_SIZE=27

COMP_MODES="C DC"

mf=machinefile-$OAR_JOBID
helena="helena -g=no-report -A=DBFS -N=EXPLORE -mf=$mf"
outDir=out/dist-compression

mkdir $outDir &> /dev/null
for n in $NODES
do
    for p in $PROCS_PER_NODE
    do
	sort -u $OAR_NODEFILE | head -$n > $mf
	[ $(cat $mf | wc -l) -lt $n ] && \
	    echo "not enough nodes for n=$n" && continue
	t=$HASH_SIZE
	q=$p
	while [ $q -gt 1 ]
	do
	    t=$((t - 1))
	    q=$((q / 2))
	done
	for mcb in $MODELS
	do
	    m=$(echo $mcb | cut -d";" -f1)
	    cb=$(echo $mcb | cut -d";" -f2)
	    baseCmd="$helena -np=$p -t=$t -cb=$cb"
	    dve="../examples/beem/$m.dve"
	    for b in $SINGLE_BUFFER_SIZES
	    do
		bs=$(((n * p - 1) * $b))
		[ $bs -gt 100000000 ] && continue
		for c in $COMP_MODES
		do
		    dir=$outDir/$m/$n/$p/$c/$b
                    mkdir -p $dir &> /dev/null
		    for r in $(seq -w 1 $REPETITION)
		    do
			xml=$dir/$r.xml
                        out=$dir/$r.out
			[ -e $xml ] && continue
			echo "***** $m, $n nodes, $p procs, b=$b, m=$c *****"
			cmd="$baseCmd -$c -o=$xml -bs=$bs $dve"
			echo $cmd
			eval $cmd | tee $out
		    done
		done
	    done
	done
	rm $mf
    done
done

exit 0
